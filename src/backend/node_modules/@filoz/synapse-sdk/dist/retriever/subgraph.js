import { fetchPiecesFromProviders } from './utils.js';
import { createError } from '../utils/errors.js';
export class SubgraphRetriever {
    subgraphService;
    childRetriever;
    constructor(subgraphService, childRetriever) {
        this.subgraphService = subgraphService;
        this.childRetriever = childRetriever;
    }
    async findProviders(commp, providerAddress) {
        if (providerAddress != null) {
            const provider = await this.subgraphService.getProviderByAddress(providerAddress);
            return provider !== null ? [provider] : [];
        }
        return await this.subgraphService.getApprovedProvidersForCommP(commp);
    }
    async fetchPiece(commp, client, options) {
        const tryChildOrThrow = async (reason) => {
            if (this.childRetriever !== undefined) {
                return await this.childRetriever.fetchPiece(commp, client, options);
            }
            throw createError('SubgraphRetriever', 'fetchPiece', `Failed to retrieve piece ${commp.toString()}: ${reason}`);
        };
        let providersToTry = [];
        try {
            providersToTry = await this.findProviders(commp, options?.providerAddress);
        }
        catch (error) {
            return await tryChildOrThrow('Provider discovery failed and no additional retriever method was configured');
        }
        if (providersToTry.length === 0) {
            return await tryChildOrThrow('No providers found and no additional retriever method was configured');
        }
        try {
            return await fetchPiecesFromProviders(providersToTry, commp, 'SubgraphRetriever', options?.signal);
        }
        catch (fetchError) {
            return await tryChildOrThrow('All provider retrieval attempts failed and no additional retriever method was configured');
        }
    }
}
//# sourceMappingURL=subgraph.js.map